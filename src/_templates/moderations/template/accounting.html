{% extends 'moderations/base.html' %}
{% load i18n %}
{% load static  %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}
<link rel="stylesheet" href="{% static 'profile/css/font-awesome/css/all.min.css' %}">
{% endblock head %}

{% block content %}
<style>
    .input-group-text i {
        font-size: 2rem!important;
    }
</style>
<div class="col-lg-12">
    <div class="card">
        <div class="card-header">
            <h4 class="card-title">{% trans 'Бухгалтерия' %}</h4>
            <div class="toolbar" role="toolbar">
                <div class="btn-group mb-1">
                    <form method="GET">
                        <div class="input-group px-3">
                            <span class="input-group-text" style="color: #43DC80;font-weight: 500;font-size: 2rem;background-color: #e6faee;"><i class="la la-calendar-check-o" aria-hidden="true"></i></span>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ default_start_date }}" required onchange="updateTotal()" style="top:0; text-align: -webkit-center;">
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ default_end_date }}" required onchange="updateTotal()" style="top:0; text-align: -webkit-center;">
                        </div>
                    </form>
                </div>
                <div class="btn-group mb-1">
                    <h6 class="mb-0" style="color: #43DC80;padding: 17px 30px;border-radius: 0.5rem;font-weight: 500;font-size: 1rem;background-color: #e6faee;">Общая сумма: <span
                            id="total_amount">{{ total_amount }}</span></h6>
                </div>
                <div class="btn-group mb-1">
                    <button type="button" class="btn btn-primary light px-3" onclick="location.href=`{% url 'moderation:accounting' %}`">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
                <div class="btn-group mb-1">
                    <button type="button" class="btn btn-primary light dropdown-toggle v" data-bs-toggle="dropdown">
                        {% trans 'Поиск по' %}
                        <span class="caret m-l-5"></span>
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="javascript:void(0);" onclick="openSearch('id')">{% trans 'Ключ' %}</a>
                        <a class="dropdown-item" href="javascript:void(0);" onclick="openSearch('user')">{% trans 'Пользователи' %}</a>
                        <a class="dropdown-item" href="javascript:void(0);" onclick="openSearch('company')">{% trans 'Компании' %}</a>
                        <a class="dropdown-item" href="javascript:void(0);" onclick="openSearch('date')">{% trans 'Дата' %}</a>
                        <a class="dropdown-item" href="javascript:void(0);" onclick="openSearch('type')">{% trans 'Статус' %}</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm mb-2">
                    <thead style="text-align: start;">
                    <tr>
                        <th>{% trans 'Ключ' %}</th>
                        <th>{% trans 'Пользователь' %}</th>
                        <th>{% trans 'Компания' %}</th>
                        <th>{% trans 'Дата' %}</th>
                        <th>{% trans 'Статус' %}</th>
                        <th>{% trans 'Сумма' %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for order in order_list %}
                    <tr>
                        <td class="py-2"><strong><a href="{% url 'moderation:accounting_detail' order.pk %}">#{{ order.key }}</a></strong></td>
                        <td class="py-2">{{ order.user }}</td>
                        <td class="py-2">{{ order.company.name }}</td>
                        <td class="py-2">{{ order.created_timestamp }}</td>
                        <td class="py-2"><div class="d-flex align-items-center"><i class="fa fa-circle {% if order.status == 2 %} text-success{% else %}text-danger{% endif %} me-1 "></i> {{ order.get_status_display }}</div></td>
                        <td class="py-2">{{ order.amount }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% include 'moderations/include/paginations.html' with items=order_list %}
        </div>
    </div>
</div>
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">{% trans 'Поиск' %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="idSearch" style="display: none;">
                    <input type="text" id="searchInput" class="form-control" placeholder="{% trans 'Введите ключ' %}">
                </div>
                <div id="dateSearch" style="display: none;">
                    <h5 class="mb-2" style="width: max-content">{% trans "Дата" %}</h5>
                    <input type="date" id="searchDate" class="form-control" placeholder="{% trans 'Выберите дату' %}">
                </div>

                <div id="typeSearch" style="display: none;">
                    <select id="typeSelect" class="form-control">
                        <option value="">{% trans 'Выберите статус' %}</option>
                        {% for status in statuses %}
                        <option value="{{ status.0 }}">{{ status.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="row select-form" style="height: 110px;display: none;" id="userSearch" >
                    <h6 class="mb-2" style="width: max-content">{% trans "Выберите пользователя" %}</h6>
                    <div class="choices" data-type="select-multiple" tabindex="0" role="combobox"
                         aria-autocomplete="list" aria-haspopup="true" aria-expanded="false"
                         style="position: relative;">
                        <select id="userSelect" class="form-control" multiple>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="iframe-container">
                        <h3> пользователи</h3>
                        <iframe src="{% url 'moderation:user_list_htmx' %}" width="100%" height="500px"></iframe>
                    </div>

                </div>
                <div class="row select-form" style="height: 110px;display: none;" id="companySearch" >
                    <h6 class="mb-2" style="width: max-content">{% trans "Выберите компанию" %}</h6>
                    <div class="choices" data-type="select-multiple" tabindex="0" role="combobox"
                         aria-autocomplete="list" aria-haspopup="true" aria-expanded="false"
                         style="position: relative;">
                        <select id="companySelect" class="form-control" multiple>
                            {% for company in companys %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Закрыть' %}</button>
                <button type="button" class="btn btn-primary" onclick="performSearch()">{% trans 'Поиск' %}</button>
            </div>
        </div>
    </div>
</div>

<script>
    function openSearch(type) {
        const modalLabel = document.getElementById('searchModalLabel');
        modalLabel.textContent = type === 'id' ? '{% trans "Поиск по ID" %}' :
            type === 'type' ? '{% trans "Поиск по типу" %}' :
                type === 'name' ? '{% trans "Поиск по заголовку" %}' :
                    type === 'date' ? '{% trans "Поиск по дате" %}' :
                        type === 'company' ? '{% trans "Поиск по компании" %}' :
                            type === 'user' ? '{% trans "Поиск по пользователю" %}' : '';

        document.getElementById('idSearch').style.display = 'none';
        document.getElementById('typeSearch').style.display = 'none';
        document.getElementById('dateSearch').style.display = 'none';
        document.getElementById('userSearch').style.display = 'none';
        document.getElementById('companySearch').style.display = 'none';

        switch (type) {
            case 'id':
                document.getElementById('idSearch').style.display = 'block';
                break;
            case 'type':
                document.getElementById('typeSearch').style.display = 'block';
                break;
            case 'date':
                document.getElementById('dateSearch').style.display = 'block';
                break;
            case 'user':
                document.getElementById('userSearch').style.display = 'block';
                break;
            case 'company':
                document.getElementById('companySearch').style.display = 'block';
                break;
        }

        $('#searchModal').modal('show');
    }

    function performSearch() {
        const searchId = document.getElementById('searchInput').value;
        const searchType = document.getElementById('typeSelect').value;
        const dateSearch = document.getElementById('searchDate').value;
        const userSelect = document.getElementById('userSelect');
        const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value);
        const companySelect = document.getElementById('companySelect');
        const selectedCompanys = Array.from(companySelect.selectedOptions).map(option => option.value);

        // Формируем URL для запроса
        const url = new URL(window.location.href);
        if (searchId) {
            url.searchParams.set('search_id', searchId);
        } else if (searchType) {
            url.searchParams.set('search_type', searchType);
        } else if (dateSearch) {
            url.searchParams.set('search_date', dateSearch);
        } else if (selectedUsers.length > 0) {
            url.searchParams.set('user_id', selectedUsers.join(',')); // Присоединяем выбранных пользователей
        } else if (selectedCompanys.length > 0) {
            url.searchParams.set('company_id', selectedCompanys.join(',')); // Присоединяем выбранных пользователей
        }
        console.log(url.toString()); // Проверяем, что URL сформирован правильно

        // Перезагружаем страницу с новыми параметрами
        window.location.href = url.toString();

        // Закрыть модальное окно после выполнения поиска
        $('#searchModal').modal('hide');
    }
</script>
<script>
    function updateTotal() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        fetch(`?start_date=${startDate}&end_date=${endDate}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('total_amount').textContent = data.total_amount + ' руб.';
            })
            .catch(error => console.error('Error:', error));
    }
</script>
{% endblock content %}