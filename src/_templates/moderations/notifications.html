{% extends 'moderations/base.html' %}
{% load i18n %}
{% load static  %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}
<link rel="stylesheet" href="{% static 'profile/css/font-awesome/css/all.min.css' %}">
{% endblock head %}

{% block content %}
<div class="col-lg-12">
    <div class="card">
        <div class="container-fluid main-tasks">
            <div class="email-wrap bookmark-wrap">
                <div class="row main-bookmark">
                    <div class="col-xl-12 col-md-12 box-col-12">
                        <div class="card-body p-0">
                            <div class="taskadd">
                                <div class="table-responsive custom-scrollbar">
                                    <table class="table" id="notifications-list">
                                        {% for notification in notifications %}
                                        <tr>
                                            <td>
                                                <h6 class="task_title_0">{{ notification.content_object.name }}</h6>
                                            </td>
                                            <td>
                                                <p class="task_desc_0">{{ notification.message }}</p>
                                            </td>
                                            <td>
                                                <a class="me-2" href="{{ notification.slug }}">
                                                    <i data-feather="link"></i>
                                                </a>
                                            </td>
                                            <td>
                                                <a  class="delete-notification" data-id="{{ notification.id }}"><i data-feather="trash-2"></i></a >
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <p>У вас нет уведомлений.</p>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% if is_paginated %}
                        <div class="pagination">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?page=1">&laquo; первая</a>
                    <a href="?page={{ page_obj.previous_page_number }}">предыдущая</a>
                {% endif %}

                <span class="current">
                    Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">следующая</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}">последняя &raquo;</a>
                {% endif %}
            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    a.delete-notification {
        cursor: pointer;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.delete-notification').on('click', function() {
            var notificationId = $(this).data('id');
            var csrftoken = getCookie('csrftoken');
            var $row = $(this).closest('tr');  // Находим ближайшую родительскую строку таблицы

            $.ajax({
                url: '{% url "moderation:delete_notification" %}',
                type: 'POST',
                data: {
                    'notification_id': notificationId,
                    'csrfmiddlewaretoken': csrftoken
                },
                success: function(response) {
                    if (response.success) {
                        $row.fadeOut(300, function() {
                            $(this).remove();
                            // Проверяем, остались ли еще уведомления
                            if ($('#notifications-list tr').length === 0) {
                                $('#notifications-list').html('<tr><td colspan="4"><p>У вас нет уведомлений.</p></td></tr>');
                            }
                        });
                    } else {
                        alert('Ошибка при удалении уведомления: ' + response.error);
                    }
                },
                error: function() {
                    alert('Произошла ошибка при отправке запроса');
                }
            });
        });

        // Функция для получения CSRF-токена из cookies
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock content %}