{% extends 'moderations/base_moderation.html' %}
{% load i18n %}
{% load static  %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}
<style>
    .red-overlay {
        background-color: rgba(255, 0, 0, 0.2); /* Красный цвет с прозрачностью 0.2 */
    }
    .gray-overlay {
        background-color: rgba(173, 0, 0, 0.2); /* Красный цвет с прозрачностью 0.2 */
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% endblock head %}

{% block content %}
<div class="group-data-[sidebar-size=sm]:min-h-sm group-data-[sidebar-size=sm]:relative" style="margin-top: 25px;">

    <div class="relative min-h-screen group-data-[sidebar-size=sm]:min-h-sm">

        <div class="container-fluid group-data-[content=boxed]:max-w-boxed mx-auto">

            <div class="card" id="employeeTable">
                <div class="card-body ">

                    <div class="d-flex row">
                        <div class="col-9">
                            <form method="GET" action="{% url 'moderation:user_list' %}" class="mb-5 flex-grow">
                                {% csrf_token %}
                                <div class="relative">
                                    <input
                                            type="text"
                                            name="q"
                                            id="user-search"
                                            value="{{ request.GET.q }}"
                                            class="form-control"
                                            placeholder="{% trans 'Поиск по ФИО' %}..."
                                            autocomplete="off">

                                </div>
                            </form>
                        </div>
                        <div class="col-3 text-end">
                            <a href="{% url 'moderation:create_user' %}" data-modal-target="addEmployeeModal"
                               type="button" style="margin-bottom: 10%;"
                               class="btn btn-primary light px-3">
                                <i class="fa fa-plus"  data-lucide="plus" ></i>
                                <span class="align-middle">Добавить пользователя</span>
                            </a>
                        </div>
                    </div>

                    <!-- Контейнер для строки поиска -->



                    <div id="user-list">
                        {% include 'moderations/users_list_partial.html' %}
                    </div>

                    <div class="flex flex-col items-center gap-4 px-4 mt-4 md:flex-row" id="pagination-element">
                        <div class="grow">
                            <p class="text-slate-500 dark:text-zink-200">
                                Показывается <b class="showing">{{ page_obj.object_list|length }}</b> из
                                <b class="total-records">{{ total_users }}</b> Клиентов
                            </p>
                        </div>

                        <div class="col-sm-auto mt-sm-0">
                            <div class="flex gap-2 pagination-wrap justify-content-center">
                                {% if page_obj.has_previous %}
                                <a class="inline-flex items-center justify-center bg-white dark:bg-zink-700 h-8 px-3 transition-all duration-150 ease-linear border rounded border-slate-200 dark:border-zink-500 text-slate-500 dark:text-zink-200 hover:text-custom-500 dark:hover:text-custom-500 hover:bg-custom-50 dark:hover:bg-custom-500/10 focus:bg-custom-50 dark:focus:bg-custom-500/10 focus:text-custom-500 dark:focus:text-custom-500"
                                   href="?page={{ page_obj.previous_page_number }}">
                                    <i class="mr-1 size-4 rtl:rotate-180" data-lucide="chevron-left"></i> Предыдущая
                                </a>
                                {% endif %}

                                <ul class="flex flex-wrap items-center gap-2 pagination listjs-pagination">
                                    {% for page_num in page_obj.paginator.page_range %}
                                    <li class="{% if page_obj.number == page_num %}active{% endif %}">
                                        <a class="inline-flex items-center justify-center bg-white dark:bg-zink-700 h-8 px-3 transition-all duration-150 ease-linear border rounded border-slate-200 dark:border-zink-500 text-slate-500 dark:text-zink-200 hover:text-custom-500 dark:hover:text-custom-500"
                                           href="?page={{ page_num }}">{{ page_num }}</a>
                                    </li>
                                    {% endfor %}
                                </ul>

                                {% if page_obj.has_next %}
                                <a class="inline-flex items-center justify-center bg-white dark:bg-zink-700 h-8 px-3 transition-all duration-150 ease-linear border rounded border-slate-200 dark:border-zink-500 text-slate-500 dark:text-zink-200 hover:text-custom-500 dark:hover:text-custom-500"
                                   href="?page={{ page_obj.next_page_number }}">
                                    Следующая <i class="ml-1 size-4 rtl:rotate-180" data-lucide="chevron-right"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

</div>
<script>
    // Функция для получения CSRF-токена из куки
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Получаем CSRF токен
    const csrftoken = getCookie('csrftoken');

    // Таймер для задержки отправки запроса
    let timer = null;

    // Общая функция для обработки запросов по обоим полям
    function performSearch() {
        clearTimeout(timer);  // Очищаем предыдущий таймер

        const nameQuery = $('#user-search').val(); // Получаем значение поиска по имени
        const contractQuery = $('#contract-search').val(); // Получаем значение поиска по номеру договора

        // Устанавливаем задержку для минимизации количества запросов
        timer = setTimeout(function () {
            $.ajax({
                url: "{% url 'moderation:user_list' %}", // URL для получения обновленного списка
                type: 'GET',
                data: {
                    'q': nameQuery,           // Передаем значение поиска по имени
                    'contract': contractQuery // Передаем значение поиска по номеру договора
                },
                dataType: 'json',
                success: function (data) {
                    // Обновляем HTML с новым списком пользователей
                    if (data.html) {
                        $('#user-list').html(data.html);
                    } else {
                        console.warn('No HTML data returned.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error); // Логирование ошибок
                }
            });
        }, 200); // 200 мс задержка перед отправкой запроса
    }

    // Обработчик ввода для поля поиска по имени
    $('#user-search').on('input', function () {
        performSearch();
    });

    // Обработчик ввода для поля поиска по номеру договора
    $('#contract-search').on('input', function () {
        performSearch();
    });
</script>
<script>
    function toggleDropdown(event) {
        event.stopPropagation(); // Предотвращаем всплытие события
        const dropdownMenu = document.getElementById('dropdownMenu');
        if (dropdownMenu.classList.contains('hidden')) {
            dropdownMenu.classList.remove('hidden');
            dropdownMenu.classList.add('block');
        } else {
            dropdownMenu.classList.remove('block');
            dropdownMenu.classList.add('hidden');
        }
    }

    // Закрытие выпадающего меню при клике вне его области
    document.addEventListener('click', function(event) {
        const dropdownMenu = document.getElementById('dropdownMenu');
        if (!dropdownMenu.contains(event.target) && !document.getElementById('userGridDropdown12').contains(event.target)) {
            dropdownMenu.classList.remove('block');
            dropdownMenu.classList.add('hidden');
        }
    });

    // Обработчик события клика для кнопки
    document.getElementById('userGridDropdown12').addEventListener('click', toggleDropdown);

    // Функция для инициализации иконок и выпадающего меню после успешного выполнения AJAX
    function initializeDropdown() {
        // Перезапуск скриптов, связанных с выпадающим меню
        document.getElementById('userGridDropdown12').addEventListener('click', toggleDropdown);

        // Здесь можете добавить другие инициализации или обновления
    }

    // Пример функции, которая вызывается после успешного выполнения AJAX
    function handleAjaxSuccess(response) {
        // Обновляем содержимое списка
        document.getElementById('user-list').innerHTML = response;

        // Инициализируем обновленные элементы
        initializeDropdown();
    }
</script>
{% endblock content %}