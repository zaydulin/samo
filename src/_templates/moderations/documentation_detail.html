{% extends 'moderations/base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}{% endblock head %}

{% block content %}
<div class="row page-titles mx-0">
    <div class="col-sm-6 p-md-0">
        <div class="welcome-text">
            <h4>{{ documentation.name }}</h4>
            <p class="mb-0">{{ description }}</p>
        </div>
    </div>
    <div class="col-sm-6 p-md-0 justify-content-sm-end mt-2 mt-sm-0 d-flex">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'moderation:dashboard' %}">{% trans 'Главная' %}</a></li>
            <li class="breadcrumb-item active"><a>{% trans 'Документация' %}</a></li>
        </ol>
    </div>
</div>
<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-xl-6">
                <div class="reviews-content">
                    <!-- Форма для создания документации -->
                    <form id="documentationForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-2" style="width: max-content">{% trans "Название" %}</h6>
                            </div>
                            <div class="mb-3">
                                {{ form.type }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-2" style="width: max-content">{% trans "Название" %}</h6>
                            </div>
                            <div class="mb-3">
                                {{ form.name }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-2" style="width: max-content">{% trans "Описание" %}</h6>
                            </div>
                            <div class="mb-3">
                                {{ form.description|safe }}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-hover-dark">
                            {% trans 'Сохранить документацию' %}
                        </button>
                    </form>
                </div>
                <div class="reviews-content mt-4 mb-4">
                <h5>{% trans "Загрузка файлов" %}</h5>
                <form id="upload-form" enctype="multipart/form-data" method="post">
                    {% csrf_token %}
                    <div class="form-group mb-4">
                        <label for="file-input" class="block text-sm font-medium mt-4">{% trans "Выберите файлы" %}</label>
                        <input type="file" name="file" id="file-input" class="form-control input-default">
                    </div>
                    <button type="submit" id="upload-button" class="btn btn-primary btn-hover-dark">
                        {% trans 'Загрузить файлы' %}
                    </button>
                </form>
            </div>
            </div>
            <div class="col-xl-6">
                <div id="list-documentation">
                    <div class="bootstrap-media" style="overflow: scroll">
                        {% for media in documentation_files %}
                            <div class="row mb-4" id="file-{{ media.id }}" style="margin-right: 0!important;margin-left: 0!important;">
                                <div class="col-xl-7">
                                    <img src="{{ media.file.url }}" alt="{{ media.file.name }}" style="max-height:200px; max-width: 100%" />
                                </div>
                                <div class="col-xl-5">
                                    <h6>{{ media.file.name|slice:":-4" }}{{ media.file.name|slice:"-4:" }}</h6>
                                    <button class="btn btn-danger btn-remove" data-id="{{ media.id }}" style="float: right">
                                        {% trans 'Удалить' %}
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% include 'moderations/include/paginations.html' with items=files_list %}
            </div>

        </div>
    </div>
</div>
<style>
.bootstrap-media {
    height: 60vh;
}
</style>
<script>
document.getElementById('upload-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Предотвращаем перезагрузку страницы

    const formData = new FormData(this);
    const url = window.location.pathname.includes('update')
        ? '/documentation/add_files/{{ documentation.id }}/'
        : '/documentation/create/'; // URL для создания документации

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'  // Добавьте CSRF-токен для защиты
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errData => {
                console.error('Ошибка:', errData.errors || 'Неизвестная ошибка');
                return;
            });
        }
        return response.json(); // Если все хорошо, парсим как JSON
    })
    .then(data => {
        if (data.success) {
            // Если документация успешно создана, загружаем файлы
            const documentationId = data.documentation_id;

            // Теперь загружаем файлы
            const fileUploadUrl = `/documentation/add_files/${documentationId}/`;
            const files = this.querySelector('input[type="file"]').files;

            Array.from(files).forEach(file => {
                const fileData = new FormData();
                fileData.append('file', file);

                fetch(fileUploadUrl, {
                    method: 'POST',
                    body: fileData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'  // Добавьте CSRF-токен для защиты
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            console.error('Ошибка при загрузке файла:', errData.errors || 'Неизвестная ошибка');
                            return;
                        });
                    }
                    return response.json();
                })
                .then(fileData => {
                    if (fileData.success) {
                        // Добавляем новый файл на страницу
                        const newFileDiv = document.createElement('div');
                        newFileDiv.classList.add('row', 'mb-4');
                        newFileDiv.id = `file-${fileData.file.id}`;
                        newFileDiv.style.marginRight = '0!important';
                        newFileDiv.style.marginLeft = '0!important';

                        newFileDiv.innerHTML = `
                            <div class="col-xl-7">
                                <img src="${fileData.file.url}" alt="${fileData.file.name}" style="max-height:200px; max-width: 100%" />
                            </div>
                            <div class="col-xl-5">
                                <h6>${fileData.file.name.split('/').pop()}</h6>
                                <button class="btn btn-danger btn-remove" data-id="${fileData.file.id}" style="float: right">
                                    {% trans 'Удалить' %}
                                </button>
                            </div>
                        `;

                        // Добавляем новый элемент в DOM
                        document.getElementById('list-documentation').querySelector('.bootstrap-media').appendChild(newFileDiv);
                    }
                });
            });
        } else {
            console.error('Ошибка при создании документации:', data.errors);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
    });
});

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-remove').forEach(button => {
        button.addEventListener('click', function() {
            const fileId = this.getAttribute('data-id');
            const url = `/documentation/delete_file/${fileId}/`; // URL для удаления файла

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // Добавьте CSRF-токен для защиты
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById(`file-${fileId}`).remove(); // Удаляем элемент из DOM
                    alert('Файл успешно удален!');
                } else {
                    alert('Ошибка при удалении файла.');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
        });
    });
});

</script>
{% endblock content %}