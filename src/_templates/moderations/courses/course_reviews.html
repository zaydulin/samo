{% extends 'moderations/base.html' %}
{% load static  %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}{% endblock head %}
{% block left-title %}{% endblock left-title %}
{% block breadcrumb %}{% endblock breadcrumb %}
{% block content %}
<!-- Container-fluid starts-->

<div class="user-profile">
    <div class="row">
        <!-- user profile first-style start-->
        <div class="col-sm-12">
            <div class="card hovercard text-center">
                <div class="cardheader" style="background: url({% if course.cover %}{{course.cover.url}}{% else %}../images/other-images/bg-profile.png{% endif %}) 10% center / cover; height: 200px;"></div>

                <div class="info">
                    <div class="row">
                        <div class="col-6">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="text-md-start">
                                        <div class="title">
                                            <a>
                                                {{course.name}}
                                            </a>
                                        </div>
                                        <div class="desc">
                                            {% if course.price <= 0 %}
                                            <a class="btn bg-primary btn-hover-effect" href="{#% url 'course_detail' course.id %#}">
                                                <i class="fa-solid fa-play me-2"></i>
                                                Пройти бесплатно
                                            </a>
                                            {% elif course.has_courseuser %}
                                            <a class="btn bg-success btn-hover-effect" href="{#% url 'course_detail' course.id %#}">
                                                <i class="fa-solid fa-check me-2"></i>
                                                Продолжить обучение
                                            </a>
                                            {% elif course.id in user_courses %}
                                            <a class="btn bg-warning btn-hover-effect" href="{#% url 'course_detail' course.id %#}">
                                                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                                Завершить оплату
                                            </a>
                                            {% else %}
                                            <a class="btn bg-primary btn-hover-effect" href="{#% url 'add_to_cart' course.id %#}">
                                                <i class="fa-solid fa-cart-shopping me-2"></i>
                                                Купить за {{ course.price }} руб.
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex" style="position: absolute; right: 0;">
                                <div style="padding-right: 5px;" class="text-md-end border-right">
                                    <div class="follow-num counter" data-target="{{ course.courserewievs_set.count }}">{{ course.courserewievs_set.count }}</div><span>Отзывов</span>
                                </div>
                                <div class="text-md-start" style="padding-left: 5px;">
                                    <div class="follow-num counter" data-target="{{ course.coursecomments_set.count }}">{{ course.coursecomments_set.count }}</div><span>Комментариев</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <ul class="nav nav-tabs border-tab tabs-scoial" id="top-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'moderation:course' course.slug %}">Информация</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'moderation:coursecomment' course.slug %}">Комментарии</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'moderation:coursereviews' course.slug %}">Отзывы</a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- user profile first-style end-->
        <div class="col-xl-3 xl-40 col-lg-6 col-md-5 box-col-4">
            <div class="default-according style-1 faq-accordion" id="accordionExample">
                {% for theme in course.themescourse.all %}
                <div class="card">
                    <div class="card-header" id="heading{{ theme.id }}">
                        <h2 class="mb-0">
                            <button class="btn btn-link btn-block text-start collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapse{{ theme.id }}"
                                    aria-expanded="false"
                                    aria-controls="collapse{{ theme.id }}">
                                {{ theme.name }}
                            </button>
                        </h2>
                    </div>
                    <div class="collapse" id="collapse{{ theme.id }}" aria-labelledby="headingv" data-bs-parent="#accordionExample" style="">
                        <div class="card-body socialprofile filter-cards-view">
                            <div class="card-body social-status filter-cards-view">
                                {% for qwiz in theme.qwiz_set.all %}
                                <div class="d-flex">
                                    <div class="flex-grow-1">
                                        <span class="f-w-600 d-block">{{ qwiz.name }}</span>
                                        <span class="d-block fw-normal">Вопросов: {{ qwiz.question_set.count }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

            </div>
        </div>
        <div class="col-xl-9 xl-60 col-lg-6 col-md-7 box-col-8e">
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="review-box">
                                <div class="row g-4" id="reviews-container">
                                    {% if not has_review %}
                                    <div class="col-xl-6">
                                        <div class="product-rating-box">
                                            <div class="modal-body">
                                                <div class="product-review-rating">
                                                    <span>Оценка</span>
                                                    <div class="product-rating main-star-rating">
                                                        <div class="common-flex star-box" id="value-star">
                                                            <i class="fa-solid fa-star active" for-value="1"></i>
                                                            <i class="fa-solid fa-star active" for-value="2"></i>
                                                            <i class="fa-solid fa-star active" for-value="3"></i>
                                                            <i class="fa-solid fa-star active" for-value="4"></i>
                                                            <i class="fa-solid fa-star" for-value="5"></i>
                                                        </div>
                                                    </div>
                                                </div>

                                                <form class="row g-3 needs-validation" id="add-reviews-form" method="post">
                                                    <div class="col-md-12">
                                                        <input class="form-control input-txt-bx" type="hidden" name="course" value="{{ course.id }}">
                                                        <input class="form-control input-txt-bx" type="hidden" name="estimate" value="">
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="content">Комментарий</label>
                                                        <textarea class="form-control" id="content" name="content" placeholder="Комментарий" required=""></textarea>
                                                    </div>
                                                    <div class="col-12">
                                                        <button class="btn btn-primary" type="submit">Отправить</button>
                                                    </div>
                                                </form>

                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="{% if has_review %}col-xl-12{% else %}col-xl-6{% endif %}">
                                        <div class="review-people">
                                            <ul class="review-list custom-scrollbar">
                                                {% for review in rewievs %}
                                                <li>
                                                    <div class="people-box">
                                                        <img class="img-fluid" src="{{review.user.avatar.url}}" alt="">
                                                        <div class="people-comment">
                                                            <div class="people-name">
                                                                <div>
                                                                    <a class="name" href="#!">{{review.user.username}}</a>
                                                                </div>
                                                                <div class="product-rating">
                                                                    <div class="common-flex">
                                                                        <i class="fa-solid fa-star fill"></i>
                                                                        <i class="fa-solid fa-star fill"></i>
                                                                        <i class="fa-solid fa-star fill"></i>
                                                                        <i class="fa-solid fa-star fill"></i>
                                                                        <i class="fa-solid fa-star fill"></i>
                                                                    </div>
                                                                </div>
                                                                <h6 class="text-content">{{review.create|date:"d/m/Y"}}</h6>
                                                            </div>
                                                            <div class="reply">
                                                                <p>{{review.content}}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            <div class="pagination">
    <span class="step-links">
        {% if rewievs.has_previous %}
            <a href="?page=1">Первая</a>
            <a href="?page={{ rewievs.previous_page_number }}">Предыдущая</a>
        {% endif %}
        <span class="current">
            Страница {{ rewievs.number }} из {{ rewievs.paginator.num_pages }}.
        </span>
        {% if rewievs.has_next %}
            <a href="?page={{ rewievs.next_page_number }}">Следующая</a>
            <a href="?page={{ rewievs.paginator.num_pages }}">Последняя</a>
        {% endif %}
    </span>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- Container-fluid Ends-->
{% endblock content %}
{% block footer %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('add-reviews-form');
        const starBox = document.getElementById('value-star');
        const estimateInput = form.querySelector('input[name="estimate"]');
        const courseInput = form.querySelector('input[name="course"]');
        const contentTextarea = form.querySelector('textarea[name="content"]');
        const reviewsContainer = document.getElementById('reviews-container');

        // Обработка выбора оценки звездами
        starBox.addEventListener('click', function(e) {
            if (e.target.tagName === 'I') {
                const value = e.target.getAttribute('for-value');
                estimateInput.value = value;

                // Обновление отображения звезд
                starBox.querySelectorAll('i').forEach(star => {
                    star.classList.remove('active');
                    if (parseInt(star.getAttribute('for-value')) <= parseInt(value)) {
                        star.classList.add('active');
                    }
                });
            }
        });

        // Обработка отправки формы
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!estimateInput.value) {
                alert('Пожалуйста, выберите оценку');
                return;
            }

            const formData = new FormData();
            formData.append('content', contentTextarea.value);
            formData.append('estimate', estimateInput.value);
            formData.append('course', courseInput.value);

            fetch('/create-reviews/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Обновление контейнера отзывов
                        refreshReviewsContainer();
                        // Очистка формы
                        form.reset();
                        starBox.querySelectorAll('i').forEach(star => star.classList.remove('active'));
                        estimateInput.value = '';
                    } else {
                        alert(data.message || 'Произошла ошибка при отправке отзыва');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Произошла ошибка при отправке отзыва');
                });
        });

        // Функция для получения CSRF токена из cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Функция для обновления контейнера отзывов
        function refreshReviewsContainer() {
            fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newReviewsContainer = doc.getElementById('reviews-container');
                    if (newReviewsContainer && reviewsContainer) {
                        reviewsContainer.innerHTML = newReviewsContainer.innerHTML;
                    }
                })
                .catch(error => {
                    console.error('Error refreshing reviews:', error);
                });
        }
    });
</script>

{% endblock footer %}