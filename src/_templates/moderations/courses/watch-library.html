<style>
    .alert {
        height: 60px;
    }
</style>


<div class="container mt-3">
    <h3 class="text-center">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="library-tab" data-bs-toggle="tab" data-bs-target="#library" type="button" role="tab" aria-controls="library" aria-selected="true">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="selected-tab" data-bs-toggle="tab" data-bs-target="#selected" type="button" role="tab" aria-controls="selected" aria-selected="false">–í—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="library" role="tabpanel" aria-labelledby="library-tab">
            <h3 class="text-center">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–∏ —ç–ª–µ–º–µ–Ω—Ç—ã:</h3>
            <div class="form-group">
                <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –º–æ–¥—É–ª—è">
            </div>
            <span class="title"> –í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: </span>
             {% for module in modules %}
                <div id="ModulePosition-{{ module.id }}">
                    <div class="form-group d-flex alert alert-dark" style="background-color: #333333;
    border-color: #333333;">
                        <div class="checkbox checkbox-dark">


                        <input class="form-check-input ml-0 mt-2" type="checkbox" id="Module-{{ module.id }}"
                               data-module-name="{{ module.name }}"
                               data-module-id="{{ module.id }}"
                               data-module-description="{{ module.description }}"
                               data-module-status="{{ module.status }}"
                               data-module-point="{{ module.point }}"
                               onchange="updateSelected()">
                        <label class="form-check-label ml-4 mt-1 mb-0" for="Module-{{ module.id }}">{{ module.name }}</label>
                            </div>
                        <div class="ml-auto">
                            {% if module.modulescourse.all.count > 0 %}
                            <button class="btn btn-link" style="color: white" type="button" data-bs-toggle="collapse" data-bs-target="#LectionPosition-{{ module.id }}">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <!-- –õ–µ–∫—Ü–∏–∏ -->
                    <div class="collapse ml-3" id="LectionPosition-{{ module.id }}">
                        {% for lecture in module.modulescourse.all %}
                        <div class="form-group d-flex alert alert-info" style="background-color: #7366ff!important;
    border-color: #7366ff!important;">
                            <div class="checkbox checkbox-dark">
                                <input class="form-check-input ml-1 mt-2" type="checkbox" name="lection"
                                       id="Lecture-{{ lecture.id }}-{{ module.id }}"
                                       data-lection-id="{{ lecture.id }}"
                                       data-lection-module="{{ module.id }}"
                                       data-lection-name="{{ lecture.name }}"
                                       data-lection-point-status="{{ lecture.status }}"
                                       data-lection-point="{{ lecture.point }}"
                                       data-lection-access-type="{{ lecture.access_type }}">
                                <label class="form-check-label ml-4 mt-1 mb-0" for="Lecture-{{ lecture.id }}-{{ module.id }}">{{ lecture.name }}</label>
                            </div>
                            {% if lecture.quizzes.all.count > 0 %}
                            <div class="ml-auto">
                                <button class="btn btn-link" style="color: white" type="button" data-bs-toggle="collapse" data-bs-target="#QwizPosition-{{ lecture.id }}">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>

                        <!-- –í–æ–ø—Ä–æ—Å—ã -->
                        <div class="collapse ml-3" id="QwizPosition-{{ lecture.id }}">
                            {% for question in lecture.quizzes.all %}
                            <div class="form-group d-flex alert alert-warning" style="background-color:  #838383!important;
    border-color:  #838383!important;">
                                  <div class="checkbox checkbox-dark">
                                <input class="form-check-input ml-1 mt-2" type="checkbox" id="Qwiz-{{ lecture.id }}-{{ question.id }}"
                                       data-qwiz-id="{{ question.id }}"
                                       data-qwiz-type="{{ question.type }}"
                                       data-qwiz-themes="{{ lecture.id }}"
                                       data-qwiz-name="{{ question.name }}"
                                       data-qwiz-point="{{ question.point }}"
                                       data-qwiz-status="{{ question.status }}">
                                <label class="form-check-label ml-4 mt-1 mb-0" for="Qwiz-{{ lecture.id }}-{{ question.id }}">{{ question.name }}</label>

                            </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

        </div>
        <!-- Selected Items Tab -->
        <div class="tab-pane fade" id="selected" role="tabpanel" aria-labelledby="selected-tab">
            <div class="mt-3">
                <h3 class="text-center">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:</h3>
                <div id="selectedItems" class="list-group">
                    <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    initializeCheckboxHandlersModule();
    initializeCheckboxHandlersLections();
    initializeCheckboxHandlersQwiz();
    initializeCheckboxHandlersQuestion();
    initializeSearch();
});
  function updateParentModuleState(element) {
    console.log('deleted')
}

function updateParentLectionState(element) {
    const lectionContainer = element.closest('[id^="LectionPosition-"]');
    if (!lectionContainer) return;

    const lectionCheckbox = lectionContainer.querySelector('[data-lection-id]');
    const allQwizCheckboxes = lectionContainer.querySelectorAll('[data-qwiz-id]');

    updateParentState(lectionCheckbox, allQwizCheckboxes);
}

function updateParentQwizState(element) {
    const qwizContainer = element.closest('[id^="QuestionPosition-"]');
    if (!qwizContainer) return;

    const qwizCheckbox = qwizContainer.parentElement.querySelector('[data-qwiz-id]');
    const allQuestionCheckboxes = qwizContainer.querySelectorAll('[data-question-id]');

    updateParentState(qwizCheckbox, allQuestionCheckboxes);
}

function initializeCheckboxHandlersModule() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥—É–ª–µ–π
    document.querySelectorAll('[data-module-id]').forEach(moduleCheckbox => {
        moduleCheckbox.addEventListener('change', function() {
            const moduleId = this.getAttribute('data-module-id');
            const lectionsContainer = document.querySelector(`#LectionPosition-${moduleId}`);

            if (lectionsContainer) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ª–µ–∫—Ü–∏–∏ –≤ –º–æ–¥—É–ª–µ
                const lectionCheckboxes = lectionsContainer.querySelectorAll('input[data-lection-id]');
                lectionCheckboxes.forEach(lectionCheckbox => {
                    lectionCheckbox.checked = this.checked;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –ª–µ–∫—Ü–∏–∏
                    const lectionId = lectionCheckbox.getAttribute('data-lection-id');
                    const qwizsContainer = document.querySelector(`#QwizPosition-${lectionId}`);
                    if (qwizsContainer) {
                        const qwizCheckboxes = qwizsContainer.querySelectorAll('input[data-qwiz-id]');
                        qwizCheckboxes.forEach(qwizCheckbox => {
                            qwizCheckbox.checked = this.checked;

                            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –≤ –≤–æ–ø—Ä–æ—Å–µ
                            const qwizId = qwizCheckbox.getAttribute('data-qwiz-id');
                            const questionsContainer = document.querySelector(`#QuestionPosition-${qwizId}`);
                            if (questionsContainer) {
                                const questionCheckboxes = questionsContainer.querySelectorAll('input[data-question-id]');
                                questionCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
                            }
                        });
                    }
                });
            }
            updateSelected();
        });
    });
}

function initializeCheckboxHandlersLections() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ª–µ–∫—Ü–∏–π

    // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    document.body.addEventListener('change', function (event) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º data-lection-id
        if (event.target.matches('[data-lection-id]')) {
            const lectionCheckbox = event.target;
            const lectionId = lectionCheckbox.getAttribute('data-lection-id');
            const qwizsContainer = document.querySelector(`#QwizPosition-${lectionId}`);
            if (qwizsContainer) {
                const qwizCheckboxes = qwizsContainer.querySelectorAll('input[data-qwiz-id]');
                qwizCheckboxes.forEach(qwizCheckbox => {
                    qwizCheckbox.checked = lectionCheckbox.checked;

                    const qwizId = qwizCheckbox.getAttribute('data-qwiz-id');
                    const questionsContainer = document.querySelector(`#QuestionPosition-${qwizId}`);
                    if (questionsContainer) {
                        const questionCheckboxes = questionsContainer.querySelectorAll('input[data-question-id]');
                        questionCheckboxes.forEach(checkbox => checkbox.checked = lectionCheckbox.checked);
                    }
                });
            }
            updateSelected();
        }
    });


}

function initializeCheckboxHandlersQwiz() {
    document.body.addEventListener('change', function(event) {
        if (event.target.matches('[data-qwiz-id]')) {
            const qwizCheckbox = event.target;
            const qwizId = qwizCheckbox.getAttribute('data-qwiz-id');
            const questionsContainer = document.querySelector(`#QuestionPosition-${qwizId}`);

            if (questionsContainer) {
                const questionCheckboxes = questionsContainer.querySelectorAll('input[data-question-id]');
                questionCheckboxes.forEach(checkbox => checkbox.checked = qwizCheckbox.checked);
            }
            updateParentLectionState(qwizCheckbox);
            updateParentModuleState(qwizCheckbox);
            updateSelected();
        }
    });
}

function initializeCheckboxHandlersQuestion() {
    document.body.addEventListener('change', function(event) {
        if (event.target.matches('[data-question-id]')) {
            const questionCheckbox = event.target;
            updateParentQwizState(questionCheckbox);
            updateParentLectionState(questionCheckbox);
            updateParentModuleState(questionCheckbox);
            updateSelected();
        }
    });
}


function updateParentState(parentCheckbox, childCheckboxes) {
    console.log('deleted')
}

function updateSelected() {
    const selectedItemsDiv = document.getElementById('selectedItems');
    selectedItemsDiv.innerHTML = '';

    const checkedItems = [
        ...document.querySelectorAll('[data-module-id]:checked'),
        ...document.querySelectorAll('[data-lection-id]:checked'),
        ...document.querySelectorAll('[data-qwiz-id]:checked'),
        ...document.querySelectorAll('[data-question-id]:checked')
    ];

    checkedItems.forEach(item => {
        const listItem = createSelectedItem(item);
        if (listItem) selectedItemsDiv.appendChild(listItem);
    });
}

function createSelectedItem(checkbox) {
    const getItemType = (checkbox) => {
        if (checkbox.hasAttribute('data-module-id')) return { type: 'module', icon: 'üìö', margin: '0' };
        if (checkbox.hasAttribute('data-lection-id')) return { type: 'lecture', icon: 'üìñ', margin: '2rem' };
        if (checkbox.hasAttribute('data-qwiz-id')) return { type: 'quiz', icon: '‚ùì', margin: '4rem' };
        if (checkbox.hasAttribute('data-question-id')) return { type: 'question', icon: '‚úì', margin: '6rem' };
        return null;
    };

    const lectionId = checkbox.getAttribute('data-lection-id') || '';
    const qwizId = checkbox.getAttribute('data-qwiz-id') || '';
    const moduleId = checkbox.getAttribute('data-module-id') || '';
    const csrfToken =  '{{ csrf_token }}'
    const itemType = getItemType(checkbox);
    if (!itemType) return null;

    const label = checkbox.nextElementSibling?.textContent.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

    const listItem = document.createElement('div');
    const courseName = '{{ course.name|escapejs }}';
    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    listItem.setAttribute('draggable', 'true');
    listItem.setAttribute('data-item-id', checkbox.id);

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    let modalContent = '';

    if (checkbox.id.startsWith('Qwiz-')) {
        modalContent = `<h5>–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç ${label}</h5>`;
                modalContent += `<input type="hidden" name="test_id" value="${qwizId}">`;
        modalContent += `<select class="form-control" name="lection_for_qwiz_id">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–µ–∫—Ü–∏—é</option>`;
        {% for module in modules_with_themes %}
            {% for theme in module.modulescourse.all %}
                modalContent += `<option value="{{ theme.id }}">{{ theme.name }}</option>`;
            {% endfor %}
        {% endfor %}
        modalContent += `</select>`;
    } else if (checkbox.id.startsWith('Lecture-')) {
        modalContent = `<h5>–î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫—Ü–∏—é ${label}</h5>`;
        modalContent += `<input type="hidden" name="addlection_id" value="${lectionId}">`;
        modalContent += `<select class="form-control" name="module_id">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å</option>`;
        {% for module in modules_with_themes %}
            modalContent += `<option value="{{ module.id }}">{{ module.name }}</option>`;
        {% endfor %}
        modalContent += `</select>`;
        modalContent += `<div class="checkbox checkbox-dark">
                                <input class="form-check-input ml-1 mt-2" type="checkbox" name="addtolectiontests" id="addtolectiontests">
                                <label class="form-check-label ml-4 mt-1 mb-0" for="addtolectiontests">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –∏–∑ —ç—Ç–æ–π –ª–µ–∫—Ü–∏–∏</label>
                           </div>`;

    } else if (checkbox.id.startsWith('Module-')) {
        modalContent = `<h5>–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å ${label} ?</h5>`;
        modalContent += `<input type="hidden" name="add_module" value="${moduleId}">`;
        modalContent += `<div class="checkbox checkbox-dark">
                                <input class="form-check-input ml-1 mt-2" type="checkbox" name="addtomodulelection" id="addtomodulelection">
                                <label class="form-check-label ml-4 mt-1 mb-0" for="addtomodulelection">–î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫—Ü–∏–∏ –∏–∑ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è</label>
                           </div>`;
        modalContent += `<div class="checkbox checkbox-dark">
                                <input class="form-check-input ml-1 mt-2" type="checkbox" name="addtomoduletests" id="addtomoduletests">
                                <label class="form-check-label ml-4 mt-1 mb-0" for="addtomoduletests">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ª–µ–∫—Ü–∏–∏</label>
                           </div>`;
    }

    listItem.innerHTML = `
        <div class="d-flex align-items-center" style="margin-left: ${itemType.margin}">
            <span class="me-2">${itemType.icon}</span>
            <span>${label}</span>
        </div>

        <button class="btn btn-info" type="button" data-bs-toggle="modal" data-bs-target="#tooltipmodal-${checkbox.id}">–î–æ–±–∞–≤–∏—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É</button>
        <div class="modal fade" id="tooltipmodal-${checkbox.id}" tabindex="-1" role="dialog" aria-labelledby="tooltipmodal-${checkbox.id}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" style="--bs-modal-width: 900px;" role="document">
            <div class="modal-content">
              <form method="post" id="libraryform-${checkbox.id}" action="{% url 'moderation:libraryupdates' %}">
              <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫—É—Ä—Å ${courseName}</h5>
                <button class="btn-close py-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                ${modalContent}
                <hr>
                <h5>–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ(–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</h5>
                <input type="text" class="form-control" name="new_name" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                <input type="hidden" name="course_id" value="{{course.id}}">
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
              </form>
            </div>
          </div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="removeSelectedItem('${checkbox.id}')">
            <i class="fas fa-times"></i>
        </button>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    setTimeout(() => {
        const form = document.getElementById(`libraryform-${checkbox.id}`);
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã

            const formData = new FormData(form); // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            const response = await fetch(form.action || '{% url  "moderation:libraryupdates" %}', { // –£–∫–∞–∂–∏—Ç–µ URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken  // –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                }
            });

            if (response.ok) {
                const result = await response.json();
                showAlert('–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success'); // –í—ã–∑—ã–≤–∞–µ–º –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é showAlert
                const modal = bootstrap.Modal.getInstance(document.getElementById(`tooltipmodal-${checkbox.id}`));
                modal.hide(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                $('#themeslist').load(location.href + ' #themeslist > *');
            } else {
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞.', 'danger');
            }
        });
    }, 0); // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

    return listItem;
}


function removeSelectedItem(checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    console.log(checkbox)
    if (checkbox) {
        checkbox.checked = false;
        const event = new Event('change');
        checkbox.dispatchEvent(event);
    }
}

function initializeSearch() {
    let timeout;

    document.body.addEventListener('input', function (event) {
        if (event.target.matches('#searchInput')) {
            clearTimeout(timeout);

            timeout = setTimeout(function () {
                let searchTerm = event.target.value.toLowerCase();

                document.querySelectorAll('[id^="ModulePosition-"]').forEach(function (module) {
                    let moduleId = module.id.split('-')[1];
                    let moduleName = module.querySelector(`#Module-${moduleId}`).dataset.moduleName.toLowerCase();
                    let isModuleVisible = moduleName.includes(searchTerm);

                    let lecturesVisible = false; // —Ñ–ª–∞–≥ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –ª–µ–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è

                    // –õ–µ–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è
                    module.querySelectorAll('.form-group.d-flex.alert-info').forEach(function (lecture) {
                        let lectureId = lecture.querySelector('input').id.split('-')[1];
                        let lectureName = lecture.querySelector('input').dataset.lectionName.toLowerCase();
                        let isLectureVisible = lectureName.includes(searchTerm);
                        // –ï—Å–ª–∏ –ª–µ–∫—Ü–∏—è –ø–æ–¥—Ö–æ–¥–∏—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
                        if (isLectureVisible) {
                            lecture.style.removeProperty('display'); // –ª–µ–∫—Ü–∏—è –≤–∏–¥–∏–º–∞—è
                        } else {
                            lecture.style.setProperty('display', 'none', 'important'); // —Å–∫—Ä—ã–≤–∞–µ–º –ª–µ–∫—Ü–∏—é
                        }

                        if (isLectureVisible) {
                            lecturesVisible = true; // –ï—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â–∞—è –ª–µ–∫—Ü–∏—è
                        }
                    });

                    // –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é –º–æ–¥—É–ª—è
                    if (isModuleVisible || lecturesVisible) {
                        module.style.removeProperty('display'); // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥—É–ª—å
                    } else {
                        module.style.setProperty('display', 'none', 'important'); // —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥—É–ª—å
                    }

                    // –ï—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–∞–π–¥–µ–Ω, –¥–µ–ª–∞–µ–º –≤—Å–µ –µ–≥–æ –ª–µ–∫—Ü–∏–∏ –≤–∏–¥–∏–º—ã–º–∏
                    if (isModuleVisible) {
                        module.querySelectorAll('.form-group.d-flex.alert-info').forEach(function (lecture) {
                            lecture.style.removeProperty('display'); // –≤—Å–µ –ª–µ–∫—Ü–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏
                        });
                    }

                    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º collapse
                    module.querySelectorAll('.collapse').forEach(function (collapse) {
                        let lectureId = collapse.id.split('-')[1];
                        let relatedLecture = module.querySelector(`#LectionPosition-${lectureId}`);

                        if (relatedLecture && relatedLecture.style.display !== 'none' && (isModuleVisible || lecturesVisible)) {
                            // –û—Ç–∫—Ä—ã–≤–∞–µ–º collapse –¥–ª—è –≤–∏–¥–∏–º–æ–π –ª–µ–∫—Ü–∏–∏ –∏ –≤–∏–¥–∏–º–æ–≥–æ –º–æ–¥—É–ª—è
                            new bootstrap.Collapse(collapse, { toggle: false }).show();
                        } else {
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º collapse, –µ—Å–ª–∏ –ª–µ–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∞ –∏–ª–∏ –º–æ–¥—É–ª—å —Å–∫—Ä—ã—Ç
                            new bootstrap.Collapse(collapse, { toggle: false }).hide();
                        }
                    });
                });

                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∏—Ö –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (searchTerm === "") {
                    document.querySelectorAll('[id^="ModulePosition-"]').forEach(function (module) {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º display –¥–ª—è –º–æ–¥—É–ª–µ–π –∏ –ª–µ–∫—Ü–∏–π
                        module.style.removeProperty('display');

                        module.querySelectorAll('.form-group.d-flex.alert-info').forEach(function (lecture) {
                            lecture.style.removeProperty('display');
                        });

                        // –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º collapse –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
                        module.querySelectorAll('.collapse').forEach(function (collapse) {
                            // –ü—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ collapse, –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
                            collapse.classList.remove('show');
                        });
                    });
                     document.querySelectorAll('[id^="LectionPosition-"]').forEach(function (lection) {
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º display –¥–ª—è –ª–µ–∫—Ü–∏–π


                            // –£–±–∏—Ä–∞–µ–º display:none –¥–ª—è –ª–µ–∫—Ü–∏–π
                            lection.style.removeProperty('display');

                            setTimeout(function() {
                                   console.log(lection);
                                   lection.classList.remove('show');
                            }, 300);

                        });

                }

            }, 800); // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 800 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞
        }
    });
}

function initializeDragAndDrop() {
    let draggedItem = null;

    document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('list-group-item')) {
            draggedItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
        }
    });

    document.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (e.target.classList.contains('list-group-item')) {
            e.dataTransfer.dropEffect = 'move';
        }
    });

    document.addEventListener('drop', function(e) {
        e.preventDefault();
        const target = e.target.closest('.list-group-item');

        if (draggedItem && target && draggedItem !== target) {
            const selectedItemsDiv = document.getElementById('selectedItems');
            const items = Array.from(selectedItemsDiv.children);

            const draggedIndex = items.indexOf(draggedItem);
            const targetIndex = items.indexOf(target);

            if (draggedIndex !== -1 && targetIndex !== -1) {
                if (draggedIndex < targetIndex) {
                    target.parentNode.insertBefore(draggedItem, target.nextSibling);
                } else {
                    target.parentNode.insertBefore(draggedItem, target);
                }
            }
        }
    });
}
</script>